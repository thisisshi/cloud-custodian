.. File Generated By c7n-sphinxext from source. Do not edit.

.. _aws.ami:

aws.ami
=======




Filters
-------


  - :ref:`cross-account <aws.ami.filters.cross-account>`

  - :ref:`event <aws.common.filters.event>`
  
  - :ref:`finding <aws.common.filters.finding>`
  
  - :ref:`image-age <aws.ami.filters.image-age>`

  - :ref:`image-attribute <aws.ami.filters.image-attribute>`

  - :ref:`marked-for-op <aws.common.filters.marked-for-op>`
  
  - :ref:`ops-item <aws.common.filters.ops-item>`
  
  - :ref:`reduce <aws.common.filters.reduce>`
  
  - :ref:`tag-count <aws.common.filters.tag-count>`
  
  - :ref:`unused <aws.ami.filters.unused>`

  - :ref:`value <aws.common.filters.value>`
  


.. _aws.ami.filters.cross-account:

cross-account
+++++++++++++
Check a resource's embedded iam policy for cross account access.
    

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      type:
        enum:
        - cross-account
      whitelist:
        items:
          type: string
        type: array
      whitelist_from:
        additionalProperties: 'False'
        properties:
          expr:
            oneOf:
            - type: integer
            - type: string
          format:
            enum:
            - csv
            - json
            - txt
            - csv2dict
          url:
            type: string
        required:
        - url
        type: object
    required:
    - type




Permissions - ec2:DescribeImageAttribute


.. _aws.ami.filters.image-age:

image-age
+++++++++
Filters images based on the age (in days)

:example:

.. code-block:: yaml

        policies:
          - name: ami-remove-launch-permissions
            resource: ami
            filters:
              - type: image-age
                days: 30

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      days:
        minimum: 0
        type: number
      op:
        enum:
        - eq
        - equal
        - ne
        - not-equal
        - gt
        - greater-than
        - ge
        - gte
        - le
        - lte
        - lt
        - less-than
        - glob
        - regex
        - regex-case
        - in
        - ni
        - not-in
        - contains
        - difference
        - intersect
      type:
        enum:
        - image-age
    required:
    - type





.. _aws.ami.filters.image-attribute:

image-attribute
+++++++++++++++
AMI Image Value Filter on a given image attribute.

Filters AMI's with the given AMI attribute

:example:

.. code-block:: yaml

        policies:
          - name: ami-unused-recently
            resource: ami
            filters:
              - type: image-attribute
                attribute: lastLaunchedTime
                key: "Value"
                op: gte
                value_type: age
                value: 30

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      attribute:
        enum:
        - description
        - kernel
        - ramdisk
        - launchPermissions
        - productCodes
        - blockDeviceMapping
        - sriovNetSupport
        - bootMode
        - tpmSupport
        - uefiData
        - lastLaunchedTime
        - imdsSupport
      default:
        type: object
      key:
        type: string
      op:
        enum:
        - eq
        - equal
        - ne
        - not-equal
        - gt
        - greater-than
        - ge
        - gte
        - le
        - lte
        - lt
        - less-than
        - glob
        - regex
        - regex-case
        - in
        - ni
        - not-in
        - contains
        - difference
        - intersect
      type:
        enum:
        - image-attribute
      value:
        oneOf:
        - type: array
        - type: string
        - type: boolean
        - type: number
        - type: 'null'
      value_from:
        additionalProperties: 'False'
        properties:
          expr:
            oneOf:
            - type: integer
            - type: string
          format:
            enum:
            - csv
            - json
            - txt
            - csv2dict
          url:
            type: string
        required:
        - url
        type: object
      value_regex:
        type: string
      value_type:
        enum:
        - age
        - integer
        - expiration
        - normalize
        - size
        - cidr
        - cidr_size
        - swap
        - resource_count
        - expr
        - unique_size
        - date
        - version
    required:
    - attribute




Permissions - ec2:DescribeImageAttribute


.. _aws.ami.filters.unused:

unused
++++++
Filters images based on usage

true: image has no instances spawned from it
false: image has instances spawned from it

:example:

.. code-block:: yaml

        policies:
          - name: ami-unused
            resource: ami
            filters:
              - type: unused
                value: true

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      type:
        enum:
        - unused
      value:
        type: boolean
    required:
    - type




Permissions - autoscaling:DescribeAutoScalingGroups, autoscaling:DescribeLaunchConfigurations, ec2:DescribeInstances, ec2:DescribeTags




Actions
-------


  - :ref:`auto-tag-user <aws.common.actions.auto-tag-user>`
  
  - :ref:`copy <aws.ami.actions.copy>`

  - :ref:`copy-related-tag <aws.common.actions.copy-related-tag>`
  
  - :ref:`deregister <aws.ami.actions.deregister>`

  - :ref:`invoke-lambda <aws.common.actions.invoke-lambda>`
  
  - :ref:`invoke-sfn <aws.common.actions.invoke-sfn>`
  
  - :ref:`mark-for-op <aws.common.actions.mark-for-op>`
  
  - :ref:`normalize-tag <aws.common.actions.normalize-tag>`
  
  - :ref:`notify <aws.common.actions.notify>`
  
  - :ref:`post-finding <aws.common.actions.post-finding>`
  
  - :ref:`post-item <aws.common.actions.post-item>`
  
  - :ref:`put-metric <aws.common.actions.put-metric>`
  
  - :ref:`remove-launch-permissions <aws.ami.actions.remove-launch-permissions>`

  - :ref:`remove-tag <aws.common.actions.remove-tag>`
  
  - :ref:`rename-tag <aws.common.actions.rename-tag>`
  
  - :ref:`set-deprecation <aws.ami.actions.set-deprecation>`

  - :ref:`set-permissions <aws.ami.actions.set-permissions>`

  - :ref:`tag <aws.common.actions.tag>`
  
  - :ref:`tag-trim <aws.common.actions.tag-trim>`
  
  - :ref:`webhook <aws.common.actions.webhook>`
  



.. _aws.ami.actions.copy:

copy
++++
Action to copy AMIs with optional encryption

This action can copy AMIs while optionally encrypting or decrypting
the target AMI. It is advised to use in conjunction with a filter.

Note there is a max in flight of 5 per account/region.

:example:

.. code-block:: yaml

        policies:
          - name: ami-ensure-encrypted
            resource: ami
            filters:
              - type: value
                key: encrypted
                value: true
            actions:
              - type: copy
                encrypt: true
                key-id: 00000000-0000-0000-0000-000000000000

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      description:
        type: string
      encrypt:
        type: boolean
      key-id:
        type: string
      name:
        type: string
      region:
        type: string
      type:
        enum:
        - copy




Permissions - ec2:CopyImage


.. _aws.ami.actions.deregister:

deregister
++++++++++
Action to deregister AMI

To prevent deregistering all AMI, it is advised to use in conjunction with
a filter (such as image-age)

:example:

.. code-block:: yaml

        policies:
          - name: ami-deregister-old
            resource: ami
            filters:
              - type: image-age
                days: 90
            actions:
              - deregister

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      delete-snapshots:
        type: boolean
      type:
        enum:
        - deregister
    required:
    - type




Permissions - ec2:DeregisterImage


.. _aws.ami.actions.remove-launch-permissions:

remove-launch-permissions
+++++++++++++++++++++++++
Action to remove the ability to launch an instance from an AMI

DEPRECATED - use set-permissions instead to support AWS Organizations
sharing as well as adding permissions

This action will remove any launch permissions granted to other
AWS accounts from the image, leaving only the owner capable of
launching it

:example:

.. code-block:: yaml

        policies:
          - name: ami-stop-share-old
            resource: ami
            filters:
              - type: image-age
                days: 60
            actions:
              - type: remove-launch-permissions

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      accounts:
        oneOf:
        - enum:
          - matched
        - maxLength: 12
          minLength: 12
          type: string
      type:
        enum:
        - remove-launch-permissions
    required:
    - type




Permissions - ec2:ResetImageAttribute, ec2:ModifyImageAttribute


.. _aws.ami.actions.set-deprecation:

set-deprecation
+++++++++++++++
Action to enable or disable AMI deprecation

To prevent deprecation of all AMIs, it is advised to use in conjunction with
a filter (such as image-age)

:example:

.. code-block:: yaml

        policies:
          - name: ami-deprecate-old
            resource: ami
            filters:
              - type: image-age
                days: 30
            actions:
              - type: set-deprecation
                #Number of days from AMI creation
                age: 90
                #Number of days from now
                #days: 90
                #Specific date/time
                #date: "2023-11-30"

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      age:
        type: integer
      date:
        type: string
      days:
        type: integer
      type:
        enum:
        - set-deprecation
    required:
    - type




Permissions - ec2:EnableImageDeprecation, ec2:DisableImageDeprecation


.. _aws.ami.actions.set-permissions:

set-permissions
+++++++++++++++
Set or remove AMI launch permissions

This action will add or remove launch permissions granted to other
AWS accounts, organizations or organizational units from the image.

Use the 'add' and 'remove' parameters to control which principals
to add or remove, respectively.  The default is to remove any permissions
granted to other AWS accounts.  Principals can be an AWS account id,
an organization ARN, or an organizational unit ARN

Use 'remove: matched' in combination with the 'cross-account' filter
for more flexible removal options such as preserving access for a set of
whitelisted accounts:

:example:

.. code-block:: yaml

        policies:
          - name: ami-share-remove-cross-account
            resource: ami
            filters:
              - type: cross-account
                whitelist:
                  - '112233445566'
                  - 'arn:aws:organizations::112233445566:organization/o-xxyyzzaabb'
                  - 'arn:aws:organizations::112233445566:ou/o-xxyyzzaabb/ou-xxyy-aabbccdd'
            actions:
              - type: set-permissions
                remove: matched
            # To remove all permissions
            # - type: set-permissions
            # To remove public permissions
            # - type: set-permissions
            #   remove:
            #     - all
            # To remove specific permissions
            # - type: set-permissions
            #   remove:
            #     - '223344556677'
            #     - 'arn:aws:organizations::112233445566:organization/o-zzyyxxbbaa'
            #     - 'arn:aws:organizations::112233445566:ou/o-zzyyxxbbaa/ou-xxyy-ddccbbaa'
            # To set specific permissions
            # - type: set-permissions
            #   remove: matched
            #   add:
            #     - '223344556677'
            #     - 'arn:aws:organizations::112233445566:organization/o-zzyyxxbbaa'
            #     - 'arn:aws:organizations::112233445566:ou/o-zzyyxxbbaa/ou-xxyy-ddccbbaa'

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      add:
        items:
          type: string
        type: array
      remove:
        oneOf:
        - enum:
          - matched
        - items:
            type: string
          type: array
      type:
        enum:
        - set-permissions
    required:
    - type




Permissions - ec2:ResetImageAttribute, ec2:ModifyImageAttribute

